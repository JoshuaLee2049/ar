<script>
    (function () {
        'use strict';
        // å·¥å…·ï¼šDOM å¿«æ·
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        // =====================
        // i18n å­—å…¸ (å·²æ“´å……)
        // =====================
        const i18n = {
            'zh-Hant': {
                ui_lang: 'ä»‹é¢èªè¨€:',
                title: 'æ–‡åŒ–æ™ºéŠå„€è¡¨æ¿',
                nav_guide: 'å°è¦½', nav_knowledge: 'çŸ¥è­˜åº«', nav_experience: 'é«”é©—', nav_personal: 'å€‹äººä¸­å¿ƒ',
                h2_api: 'API æ•´åˆæœå‹™æ¨¡çµ„', p_api: 'ç³»çµ±æœå‹™ç‹€æ…‹èˆ‡é‡‘é‘°è¨­å®š', status_rag: 'RAG æœå‹™ï¼šå°šæœªé€£ç·š', status_data: 'é–‹æ”¾è³‡æ–™ï¼šåŒæ­¥ä¸­', btn_save: 'å„²å­˜è¨­å®š',
                h2_guide: 'AI æ™ºèƒ½å°è¦½', p_guide: 'æ‚¨çš„éš¨èº«æ–‡åŒ–åš®å°', chat_init: '[ç³»çµ±åˆå§‹åŒ–] æª¢æ¸¬åˆ° RAG æ ¸å¿ƒæœªå•Ÿå‹•ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„ Gemini Key ä»¥é€£ç·šæ–‡åŒ–çŸ¥è­˜åº«ã€‚', placeholder_chat: 'è¼¸å…¥æ‚¨çš„æ–‡åŒ–å•é¡Œæˆ–å°è¦½éœ€æ±‚...', btn_send: 'ç™¼é€',
                h2_db: 'æ–‡åŒ–çŸ¥è­˜åº«', p_db: 'æ¢ç´¢å…¨å°æ–‡åŒ–è³‡ç”¢ (RAG è³‡æ–™æº)', btn_import: 'â†“ åŒ¯å…¥æ–°è³‡æ–™', placeholder_search: 'æœå°‹å¤è¹Ÿã€æ–‡ç‰©ã€æ­·å²äº‹ä»¶...',
                filter_all: 'å…¨éƒ¨', filter_monument: 'å¤è¹Ÿ', filter_museum: 'åšç‰©é¤¨', filter_intangible: 'ç„¡å½¢æ–‡åŒ–',
                h2_immersive: 'æ²‰æµ¸å¼é«”é©—', p_immersive: 'å•Ÿå‹•æ‚¨çš„æ™‚å…‰æ©Ÿ', tag_ar: 'AR å¯¦æ™¯é‚„åŸ', h4_anping: 'å®‰å¹³å¤å ¡ï¼šç†±è˜­é®åŸ 1632', tag_vr: 'VR è™›æ“¬å±•é¤¨', h4_taipei: 'å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰† (æ•¸ä½é‡å»º)',
                h2_local: 'åœ¨åœ°å³æ™‚è³‡è¨Š', p_local: 'æ•´åˆé–‹æ”¾è³‡æ–™', map_placeholder: '--- äº’å‹•åœ°åœ–è¼‰å…¥å€åŸŸ ---', bus_route: '[å¸‚å€å…¬è»Š] 77è·¯', bus_status: 'å³å°‡æŠµé”ï¼šèµ¤å´æ¨“ç«™ (3 åˆ†é˜)', event_name: '[ç¯€æ…¶æ´»å‹•] åºœåŸæ–‡åŒ–ç¯€', event_status: 'é€²è¡Œä¸­ï¼šå­”å»Ÿåœ’å€ (è·é›¢ 1.2km)',
                h2_personal: 'å€‹äººåŒ–ä¸­å¿ƒ', p_personal: 'æ‚¨çš„æ–‡åŒ–è¶³è·¡', card_fav: 'æˆ‘çš„æ”¶è—', card_fav_p: 'æ‚¨å·²æ”¶è— 12 å€‹æ™¯é»èˆ‡ 3 ç¯‡å°è¦½', card_trip: 'æˆ‘çš„è¡Œç¨‹', card_trip_p: 'æ‚¨æœ‰ 1 å€‹å³å°‡åˆ°ä¾†çš„è¡Œç¨‹ (å°å—ä¸‰æ—¥éŠ)', card_ach: 'æˆ‘çš„æˆå°±', card_ach_p: 'å·²è§£é–ã€ŒåºœåŸæ¢ç´¢è€…ã€å¾½ç« ',
                
                // Modal & åŒ¯å…¥
                modal_title: 'åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢',
                modal_label_name: 'è³‡ç”¢åç¨± (å¿…å¡«)',
                modal_label_location: 'åœ°é» / ç¸£å¸‚ (å¿…å¡«)',
                modal_label_type: 'é¡å‹ (å¤è¹Ÿ/åšç‰©é¤¨/ç„¡å½¢æ–‡åŒ–...)',
                modal_label_img: 'åœ–ç‰‡ URL (é¸å¡«)',
                modal_label_desc: 'ç°¡è¦æè¿° (ç”¨æ–¼ AI å°è¦½ RAG)',
                modal_h4_csv: 'æˆ–ï¼šæ‰¹æ¬¡åŒ¯å…¥ CSV è³‡æ–™',
                btn_ai_summarize: 'ğŸ¤– AI è‡ªå‹•æ‘˜è¦ (æ¨¡æ“¬)',
                btn_cancel: 'å–æ¶ˆ',
                btn_submit: 'å–®ç­†åŒ¯å…¥ä¸¦å•Ÿç”¨',
                btn_import_csv: 'æ‰¹æ¬¡åŒ¯å…¥ CSV',
                
                // Toast
                toast_lang_switched: (isZh) => `ä»‹é¢å·²åˆ‡æ›ç‚º ${isZh ? 'ç¹é«”ä¸­æ–‡' : 'English'}ï¼ˆå·²å„²å­˜ï¼‰`,
                toast_key_ok: 'API Key å„²å­˜ä¸¦é©—è­‰æˆåŠŸï¼æœå‹™æ ¸å¿ƒå•Ÿå‹•ã€‚',
                toast_key_bad: 'Gemini API Key æ ¼å¼éŒ¯èª¤æˆ–ç„¡æ•ˆã€‚',
                toast_need_key: 'è«‹å…ˆåœ¨ API è¨­å®šæ¨¡çµ„ä¸­è¼¸å…¥æœ‰æ•ˆçš„ Gemini Keyã€‚',
                toast_import_error: 'è«‹å¡«å¯«ã€Œè³‡ç”¢åç¨±ã€èˆ‡ã€Œåœ°é»ã€ã€‚',
                toast_import_ok: (name) => `æˆåŠŸåŒ¯å…¥è³‡ç”¢ï¼šã€Œ${name}ã€ã€‚å·²åŠ å…¥ RAG è³‡æ–™æºã€‚`,
                toast_ai_summarizing: 'AI æ‘˜è¦è™•ç†ä¸­...',
                toast_ai_summarize_ok: 'æ‘˜è¦å®Œæˆï¼å·²å›å¡«è‡³æè¿°æ¬„ä½ã€‚',
                toast_import_csv_error: 'CSV åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå’Œæ ¼å¼ (éœ€åŒ…å« title/location æ¬„ä½)ã€‚',
                toast_import_csv_ok: (count) => `æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡ç”¢ã€‚å·²åŠ å…¥ RAG è³‡æ–™æºã€‚`,
            },
            en: {
                ui_lang: 'Language:',
                title: 'Culture Guide Dashboard', nav_guide: 'Guide', nav_knowledge: 'Knowledge Base', nav_experience: 'Experience', nav_personal: 'Personal Center',
                h2_api: 'API Integration Module', p_api: 'System Status and Key Settings', status_rag: 'RAG Service: Disconnected', status_data: 'Open Data: Syncing', btn_save: 'Save Settings',
                h2_guide: 'AI Smart Guide', p_guide: 'Your Personal Culture Companion', chat_init: '[System Init] RAG Core Offline. Please enter your Gemini Key above to connect the Knowledge Base.', placeholder_chat: 'Enter your culture question or guidance request...', btn_send: 'Send',
                h2_db: "Cultural Knowledge Base", p_db: "Explore Taiwan's Cultural Assets (RAG Source)", btn_import: 'â†“ Import New Data', placeholder_search: 'Search: Monuments, artifacts, history...',
                filter_all: 'ALL', filter_monument: 'Monuments', filter_museum: 'Museums', filter_intangible: 'Intangible',
                h2_immersive: 'Immersive Experience', p_immersive: 'Launch Your Time Machine', tag_ar: 'AR Live Restoration', h4_anping: 'Anping Fort: Zeelandia 1632', tag_vr: 'VR Virtual Exhibition', h4_taipei: 'Lost Taipei City Walls (Digital)',
                h2_local: 'Local Real-Time Info', p_local: 'Open Data Integration', map_placeholder: '--- Interactive Map Loading Area ---', bus_route: '[TRANSIT] Route 77', bus_status: 'Arriving: Chikan Tower (3 min)', event_name: '[EVENT] Fucheng Culture Fest', event_status: 'Active: Confucius Temple (1.2km)',
                h2_personal: 'Personal Center', p_personal: 'Your Cultural Footprint', card_fav: 'My Favorites', card_fav_p: '12 assets and 3 tours saved.', card_trip: 'My Trips', card_trip_p: '1 upcoming itinerary (Tainan 3-Day)', card_ach: 'My Achievements', card_ach_p: "Achieved: 'Fucheng Explorer' Badge",
                
                // Modal & Import
                modal_title: 'Import Custom Cultural Asset',
                modal_label_name: 'Asset Name (Required)',
                modal_label_location: 'Location / City (Required)',
                modal_label_type: 'Type (Monument/Museum/Intangible...)',
                modal_label_img: 'Image URL (Optional)',
                modal_label_desc: 'Brief Description (for RAG)',
                modal_h4_csv: 'OR: Batch Import CSV Data',
                btn_ai_summarize: 'ğŸ¤– AI Auto Summarize (Simulated)',
                btn_cancel: 'Cancel',
                btn_submit: 'Import Single Asset',
                btn_import_csv: 'Batch Import CSV',
                
                // Toast
                toast_lang_switched: (isZh) => `Language switched to ${isZh ? 'ç¹é«”ä¸­æ–‡' : 'English'} (saved)`,
                toast_key_ok: 'API Key validated! Service core started.',
                toast_key_bad: 'Gemini API Key error or invalid.',
                toast_need_key: 'Please enter a valid Gemini Key in API settings first.',
                toast_import_error: 'Please fill Asset Name & Location.',
                toast_import_ok: (name) => `Imported: "${name}". Added to RAG source.`,
                toast_ai_summarizing: 'AI summarizing in progress...',
                toast_ai_summarize_ok: 'Summarization complete! Result filled into description.',
                toast_import_csv_error: 'CSV import failed. Check file and format (requires title/location columns).',
                toast_import_csv_ok: (count) => `Successfully imported ${count} assets. Added to RAG source.`,
            }
        };

        // =====================
        // App ç‹€æ…‹ & å…¨åŸŸè®Šæ•¸
        // =====================
        const state = {
            lang: localStorage.getItem('lang') || 'zh-Hant',
            ragReady: localStorage.getItem('ragReady') === 'true',
            geminiKey: localStorage.getItem('geminiKey') || '',
            mapsKey: localStorage.getItem('mapsKey') || '', // æ–°å¢ï¼šGoogle Maps Key
            knowledge: [], 
            filter: 'all',
            search: '',
            localFilter: 'all', // æ–°å¢ï¼šYouBike åˆ—è¡¨ç¯©é¸ç‹€æ…‹ ('all', 'bikes', 'docks')
        };

        const DEFAULT_KB = [
            { id: '1', type: 'monument', title_zh: 'èµ¤å´æ¨“', info_zh: 'å°å—å¸‚ / ä¸€ç´šå¤è¹Ÿ', title_en: 'Chikan Tower', info_en: 'Tainan / Grade 1 Monument', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Chikan+Tower', desc: 'èµ¤å´æ¨“å§‹å»ºæ–¼ 1653 å¹´ï¼Œç‚ºè·è˜­äººæ‰€å»ºï¼Œæ­·ç¶“æ¸…æœé‡å»ºèˆ‡æ—¥æ²»æ™‚æœŸä¿®ç¹•ï¼Œæ˜¯å°å—æœ€å…·ä»£è¡¨æ€§çš„å¤è¹Ÿä¹‹ä¸€ã€‚'},
            { id: '2', type: 'museum', title_zh: 'è¥¿é–€ç´…æ¨“', info_zh: 'å°åŒ—å¸‚ / æ­·å²å»ºç¯‰', title_en: 'Ximen Red House', info_en: 'Taipei / Historical Building', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Red+House', desc: 'è¥¿é–€ç´…æ¨“æ˜¯ä¸€åº§å…©å±¤é«˜çš„ç´…ç£šæ´‹æ¨“ï¼Œè¦‹è­‰äº†è¥¿é–€ç”ºçš„æ­·å²ç™¼å±•ã€‚'},
            { id: '3', type: 'intangible', title_zh: 'åª½ç¥–ç¹å¢ƒ', info_zh: 'ä¸­å°ç£ / ç„¡å½¢æ–‡åŒ–', title_en: 'Mazu Pilgrimage', info_en: 'Central Taiwan / Intangible Heritage', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Mazu+Pilgrimage', desc: 'ä¸­å…ƒæ™®æ¸¡æ°‘ä¿—èˆ‡å®—æ•™æ–‡åŒ–çš„ä»£è¡¨æ´»å‹•ä¹‹ä¸€ï¼Œå¼·èª¿å°å…ˆäººæ•¬æ„èˆ‡ç¤¾ç¾¤é€£çµã€‚'},
        ];
        
        // åœ°åœ–ç›¸é—œå…¨åŸŸè®Šæ•¸
        let map; // Google Map å¯¦ä¾‹
        let userLocation = { lat: 25.0478, lng: 121.5318 }; // é è¨­ä½ç½®ï¼šå°åŒ—è»Šç«™
        window.youbikeMarkers = []; // å„²å­˜æ‰€æœ‰ YouBike Marker å¯¦ä¾‹
        window.allYouBikeStations = []; // å„²å­˜æ‰€æœ‰ç«™é»è³‡æ–™ä¾›åˆ—è¡¨ç¯©é¸ä½¿ç”¨

        // =====================
        // DOM åƒç…§
        // =====================
        const ragDot = $('#rag-dot');
        const ragText = $('#rag-text');
        const btnSaveAPI = $('#btn-save-api');
        const inputGemini = $('#gemini-api');
        const inputMapsApi = $('#maps-api'); // Maps API Input

        const btnZh = $('#btn-zh');
        const btnEn = $('#btn-en');

        const kbGrid = $('#kb-grid');
        const kbTpl = $('#kb-card-tpl');
        const kbSearch = $('#kb-search');
        const filterButtons = $$('.filter');

        const chatBox = $('#chat');
        const chatInput = $('#chat-input');
        const btnSend = $('#btn-send');

        const localToggle = $('#local-toggle');
        const meToggle = $('#me-toggle');
        
        const localList = $('#local-list'); // å³æ™‚è³‡è¨Šåˆ—è¡¨

        const modal = $('#import-modal');
        const btnImport = $('#btn-import');
        const btnCloseModal = $('#btn-close-modal');
        const btnCancel = $('#btn-cancel');
        const importForm = $('#import-form');
        
        // åŒ¯å…¥æ¨¡çµ„ç›¸é—œ
        const inputName = $('#asset-name');
        const inputLoc = $('#asset-location');
        const inputType = $('#asset-type');
        const inputImgUrl = $('#asset-img-url');
        const inputDesc = $('#asset-desc');
        const btnAiSummarize = $('#btn-ai-summarize');
        const inputFileCsv = $('#asset-csv-file');
        const btnImportCsv = $('#btn-import-csv');
        
        // åˆ—è¡¨ç¯©é¸æŒ‰éˆ•
        const filterButtonsLocal = $$('.filter-controls .filter-btn');

        const toaster = $('#toast');

        // =====================
        // åˆå§‹åŒ–
        // =====================
        function init() {
            // API å›å¡«
            inputGemini.value = state.geminiKey;
            inputMapsApi.value = state.mapsKey;
            setRagUI(state.ragReady);

            // èªè¨€ & æ–‡æ¡ˆ
            applyLang(state.lang, false); 

            // çŸ¥è­˜åº«è¼‰å…¥
            loadKnowledge();
            renderKB();

            // äº‹ä»¶ç¶å®š
            bindEvents();

            // å•Ÿå‹•åœ°åœ–æ¨¡çµ„ (åœ¨åœ°å³æ™‚è³‡è¨Š)
            loadLocalInfoMap();
            
            // åˆå§‹èŠå¤©
            if (state.ragReady) {
                chatBox.innerHTML = '';
                addBubble('ai', t('chat_init').replace('å°šæœªé€£ç·š', 'å·²é€£ç·š'));
            } else {
                addBubble('ai', t('chat_init'));
            }
        }

        // =====================
        // i18n
        // =====================
        function t(key, arg = null) {
            const lang = state.lang in i18n ? state.lang : 'zh-Hant';
            const val = i18n[lang][key];
            if (typeof val === 'function') {
                return val(arg);
            }
            return val ?? key;
        }

        function applyLang(lang, showToast = true) {
            state.lang = lang;
            const dict = i18n[lang] || i18n['zh-Hant'];
            // æ›´æ–° data-key æ–‡æ¡ˆ
            $$('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                let val = dict[key];

                if (typeof val === 'function') {
                    val = key; // ä¿æŒåŸæ¨£
                }

                if (!val) return;
                if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                    el.placeholder = val;
                } else if (el.tagName !== 'INPUT' && el.tagName !== 'TEXTAREA') { // é¿å…è¦†è“‹ input/textarea value
                    el.textContent = val;
                }
            });
            $('#app-title').textContent = t('title');
            localStorage.setItem('lang', lang);
            if (showToast) {
                toast(t('toast_lang_switched', lang === 'zh-Hant'), 'success');
            }
            renderKB(); // åˆ‡æ›å¡ç‰‡èªè¨€
            setRagUI(state.ragReady); // æ›´æ–° RAG æ–‡æ¡ˆ
        }

        // =====================
        // RAG / API ç‹€æ…‹
        // =====================
        function setRagUI(ready) {
            state.ragReady = ready;
            if (ready) {
                ragDot.classList.add('ok');
                ragText.textContent = (state.lang === 'zh-Hant') ? 'RAG æœå‹™ï¼šå·²é€£ç·š' : 'RAG Service: Connected';
            } else {
                ragDot.classList.remove('ok');
                ragText.textContent = t('status_rag');
            }
            localStorage.setItem('ragReady', ready);
        }
        
        // =====================
        // çŸ¥è­˜åº«ï¼šè¼‰å…¥/å„²å­˜/æ¸²æŸ“
        // (CSV å°å…¥é‚è¼¯èˆ‡ä¸Šå€‹ç‰ˆæœ¬ç›¸åŒ)
        // =====================
        function loadKnowledge() {
            let custom = [];
            try { custom = JSON.parse(localStorage.getItem('customKnowledge') || '[]'); } catch {}
            custom = custom.map(a => ({ type: (a.type || 'custom').toLowerCase(), ...a }));
            state.knowledge = [...DEFAULT_KB, ...custom];
        }

        function renderKB() {
            // ... (èˆ‡ä¸Šå€‹ç‰ˆæœ¬ç›¸åŒ) ...
            kbGrid.innerHTML = '';
            const isZh = state.lang === 'zh-Hant';
            
            const filteredKB = state.knowledge.filter(asset => {
                const title = isZh ? asset.title_zh : asset.title_en;
                const matchesSearch = !state.search || title.toLowerCase().includes(state.search.toLowerCase());
                const matchesFilter = state.filter === 'all' || asset.type === state.filter;
                return matchesSearch && matchesFilter;
            });

            filteredKB.forEach(asset => {
                const clone = kbTpl.content.cloneNode(true);
                const card = $('.kb-card', clone);
                const img = $('img', clone);
                const titleEl = $('.title', clone);
                const metaEl = $('.meta', clone);

                card.setAttribute('data-id', asset.id);
                img.src = asset.img_url;
                img.alt = isZh ? asset.title_zh : asset.title_en;
                titleEl.textContent = isZh ? asset.title_zh : asset.title_en;
                metaEl.textContent = isZh ? asset.info_zh : asset.info_en;

                kbGrid.appendChild(clone);
            });
        }
        
        function parseCsv(csvText) {
             // ... (èˆ‡ä¸Šå€‹ç‰ˆæœ¬ç›¸åŒ) ...
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) return null; 
            const headers = lines[0].toLowerCase().split(',').map(h => h.trim()); 
            
            const requiredFields = ['title', 'location'];
            if (!requiredFields.every(field => headers.some(h => h.includes(field)))) {
                return null; 
            }

            const data = [];
            const now = Date.now();

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length !== headers.length) continue; 

                const asset = {
                    id: `custom-${now}-${i}`,
                    title_zh: values[headers.indexOf('title_zh')]?.trim() || values[headers.indexOf('title')]?.trim(),
                    info_zh: values[headers.indexOf('location_zh')]?.trim() || values[headers.indexOf('location')]?.trim() || 'æœªçŸ¥åœ°é»',
                    type: (values[headers.indexOf('type')]?.trim() || 'custom').toLowerCase(),
                    img_url: values[headers.indexOf('img_url')]?.trim() || 'https://via.placeholder.com/640x360/443311/aaaaaa?text=No+Image',
                    desc: values[headers.indexOf('desc')]?.trim() || '',
                    title_en: values[headers.indexOf('title_en')]?.trim() || values[headers.indexOf('title_zh')]?.trim(),
                    info_en: values[headers.indexOf('location_en')]?.trim() || values[headers.indexOf('location_zh')]?.trim() || 'Unknown Location',
                };

                if (asset.title_zh && asset.info_zh) {
                    data.push(asset);
                }
            }
            return data;
        }

        // =====================
        // èŠå¤© / RAG æ¨¡æ“¬
        // (èˆ‡ä¸Šå€‹ç‰ˆæœ¬ç›¸åŒ)
        // =====================
        function addBubble(type, text) {
            const bubble = document.createElement('div');
            bubble.className = `bubble ${type}`;
            bubble.textContent = text;
            chatBox.appendChild(bubble);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function handleAIChat(question) {
            addBubble('user', question);
            chatInput.value = '';

            if (!state.ragReady) {
                setTimeout(() => {
                    addBubble('ai', t('toast_need_key'));
                }, 800);
                return;
            }

            setTimeout(() => {
                let response = `å¥½çš„ï¼Œé—œæ–¼ã€Œ${question}ã€çš„è³‡è¨Šå·²å¾ RAG çŸ¥è­˜åº«ä¸­æå–ã€‚`;
                
                const relevantAsset = state.knowledge.find(a => (a.title_zh + a.desc).includes(question.substring(0, 2)));

                if (relevantAsset) {
                    const title = (state.lang === 'zh-Hant') ? relevantAsset.title_zh : relevantAsset.title_en;
                    response += `\n\n[çŸ¥è­˜å¼•ç”¨] æ ¹æ“šæ‚¨æå•çš„å…§å®¹ï¼ŒçŸ¥è­˜åº«ä¸­æ‰¾åˆ°ç›¸é—œè³‡ç”¢ï¼š${title} (${relevantAsset.info_zh})ã€‚\næè¿°ï¼š${relevantAsset.desc.substring(0, 50)}...`;
                } else {
                    response += `\n\nçŸ¥è­˜åº«ä¸­æœªæ‰¾åˆ°ç›´æ¥ç›¸é—œå…§å®¹ï¼ŒAI å°‡ä»¥é€šç”¨çŸ¥è­˜å›ç­”...`;
                }

                addBubble('ai', response);
            }, 1500);
        }
        
        // =====================
        // Google Maps & å³æ™‚è³‡è¨Š (æ•´åˆåŠŸèƒ½)
        // =====================
        
        /**
         * Helper function: è¨ˆç®—è·é›¢ (å…¬é‡Œ)
         */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾‘ (å…¬é‡Œ)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // è·é›¢ (å…¬é‡Œ)
        }

        /**
         * å•Ÿå‹•åœ°åœ–å’Œå³æ™‚è³‡æ–™æµç¨‹
         */
        async function loadLocalInfoMap() {
            const mapsApiKey = inputMapsApi.value;
            if (!mapsApiKey) {
                $('#map-container').innerHTML = `<p style="color:var(--bad); padding:1rem;">è«‹åœ¨ä¸Šæ–¹ API æ¨¡çµ„è¼¸å…¥æœ‰æ•ˆçš„ Maps API Key ä»¥å•Ÿç”¨äº’å‹•åœ°åœ–ã€‚</p>`;
                return;
            }

            // 1. å˜—è©¦å–å¾—ä½¿ç”¨è€…ä½ç½®
            getUserGeolocation().then(coords => {
                userLocation = { lat: coords.latitude, lng: coords.longitude };
            }).catch(() => {
                console.warn("ç„¡æ³•å–å¾—ä½¿ç”¨è€…åœ°ç†ä½ç½®ï¼Œä½¿ç”¨é è¨­åº§æ¨™ (å°åŒ—)ã€‚");
            }).finally(() => {
                // 2. åˆå§‹åŒ–åœ°åœ–
                initializeGoogleMap(mapsApiKey);

                // 3. å‘¼å« YouBike è³‡æ–™
                fetchYouBikeData(userLocation); 

                // å®šæ™‚å™¨ï¼šæ¯ 60 ç§’æ›´æ–°ä¸€æ¬¡
                setInterval(() => fetchYouBikeData(userLocation), 60000); 
            });
        }

        function getUserGeolocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve(position.coords),
                        (error) => reject(error),
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                } else {
                    reject(new Error("ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®æœå‹™ã€‚"));
                }
            });
        }
        
        function initializeGoogleMap(apiKey) {
            if (window.google && window.google.maps) {
                window.renderMap(userLocation); 
                return;
            }
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=renderMap&libraries=places&v=weekly`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);

            window.renderMap = (center) => {
                if (!center) center = userLocation;

                const mapOptions = { center: center, zoom: 14, mapId: 'YOUR_MAP_ID', fullscreenControl: false, streetViewControl: false };

                map = new google.maps.Map(document.getElementById('map-container'), mapOptions);
                
                // æ”¾ç½®ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
                new google.maps.Marker({ position: center, map: map, title: 'æ‚¨çš„ä½ç½®', icon: { url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png', scaledSize: new google.maps.Size(40, 40) } });

                // ç›£è½åœ°åœ–ç¸®æ”¾å’Œç§»å‹•äº‹ä»¶
                map.addListener('zoom_changed', filterMarkersByZoom);
                map.addListener('dragend', filterMarkersByZoom);
                
                if (window.allYouBikeStations.length > 0) {
                     renderYouBikeMarkers(window.allYouBikeStations);
                }
            };
        }

        async function fetchYouBikeData(center) {
            const youbikeApiUrl = 'https://data.ntpc.gov.tw/api/v1/rest/datastore/382000000A-000352-001'; 
            
            try {
                const response = await fetch(youbikeApiUrl, { method: 'GET', headers: { 'Accept': 'application/json' } });
                const data = await response.json();
                
                const stations = data.result.records; 
                
                // ç¯©é¸ 5 å…¬é‡Œç¯„åœå…§çš„ç«™é»ä¸¦è¨ˆç®—è·é›¢
                const filteredStations = stations.filter(station => {
                    const stationLat = parseFloat(station.lat);
                    const stationLng = parseFloat(station.lng);
                    if (isNaN(stationLat) || isNaN(stationLng)) return false;

                    const distanceKm = getDistance(center.lat, center.lng, stationLat, stationLng);
                    station.distance = distanceKm; 
                    return distanceKm <= 5.0; 
                });

                renderYouBikeMarkers(filteredStations);
                updateLocalList(filteredStations);

            } catch (error) {
                console.error('YouBike API ä¸²æ¥å¤±æ•—:', error);
                if (arguments.length > 0 && typeof arguments[0] === 'object') { 
                    toast('å³æ™‚ YouBike ç«™é»è³‡æ–™è¼‰å…¥å¤±æ•—ã€‚', 'error');
                }
            }
        }
        
        function filterMarkersByZoom() {
            if (!map || !window.youbikeMarkers) return;
            const currentZoom = map.getZoom();
            const threshold = 13; 
            
            if (currentZoom < threshold) {
                window.youbikeMarkers.forEach(marker => marker.setVisible(false));
                if (!map.isZoomedOut) {
                    toast('åœ°åœ–ç¸®æ”¾ç´šåˆ¥å¤ªä½ï¼Œå·²éš±è—ç«™é»æ¨™è¨˜ï¼Œè«‹æ”¾å¤§åœ°åœ–ã€‚', 'info');
                    map.isZoomedOut = true;
                }
            } else {
                window.youbikeMarkers.forEach(marker => marker.setVisible(true));
                map.isZoomedOut = false;
            }
        }

        function renderYouBikeMarkers(stations) {
            if (!map) return;

            window.youbikeMarkers.forEach(marker => marker.setMap(null));
            window.youbikeMarkers = [];
            window.allYouBikeStations = stations; 

            stations.forEach(station => {
                const lat = parseFloat(station.lat);
                const lng = parseFloat(station.lng);
                const sbi = parseInt(station.sbi);
                
                const iconUrl = sbi > 0 ? 'http://maps.google.com/mapfiles/ms/icons/cycling.png' : 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'; 

                const marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    title: station.sna, 
                    icon: { url: iconUrl, scaledSize: new google.maps.Size(30, 30) }
                });

                const content = `<strong>${station.sna.replace('YouBike2.0_', '')}</strong><br>å¯å€Ÿè»Šè¼›ï¼š<span style="color: var(--ok);">${station.sbi} è¼›</span><br>å¯é‚„ç©ºä½ï¼š<span style="color: var(--secondary);">${station.bemp} å€‹</span>`;
                const infoWindow = new google.maps.InfoWindow({ content: content });
                marker.addListener('click', () => { infoWindow.open(map, marker); });
                
                window.youbikeMarkers.push(marker); 
            });
            filterMarkersByZoom(); 
        }
        
        function updateLocalList(stations) {
            if (!stations) return;
            
            // æ‡‰ç”¨ç¯©é¸é‚è¼¯
            const filteredAndSortedStations = stations
                .filter(station => {
                    const sbi = parseInt(station.sbi); 
                    const bemp = parseInt(station.bemp); 
                    
                    if (state.localFilter === 'bikes') {
                        return sbi >= 3;
                    } else if (state.localFilter === 'docks') {
                        return bemp >= 3;
                    }
                    return true;
                })
                .sort((a, b) => a.distance - b.distance); // æŒ‰è·é›¢æ’åº

            localList.innerHTML = '';
            
            if (filteredAndSortedStations.length === 0) {
                let message = 'é™„è¿‘æ²’æœ‰ YouBike ç«™é»è³‡æ–™ã€‚';
                if (state.localFilter !== 'all') {
                     message = `ç›®å‰æ¢ä»¶ä¸‹ï¼Œé™„è¿‘æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç«™é»ã€‚`;
                }
                localList.innerHTML = `<li class="kb-card" style="opacity:0.7;">${message}</li>`;
                return;
            }

            filteredAndSortedStations.forEach(station => {
                const listItem = document.createElement('li');
                listItem.className = 'kb-card real-time-card';
                listItem.innerHTML = `
                    <div style="flex-grow: 1;">
                        <p class="meta" style="color: var(--ok); font-weight: bold;">[YouBike 2.0 ç«™é»]</p>
                        <h4 class="title" style="margin-top: 0.2rem;">${station.sna.replace('YouBike2.0_', '')}</h4>
                        <p class="meta">
                            å¯å€Ÿï¼š<span style="color: ${station.sbi > 0 ? 'var(--ok)' : 'var(--bad)'};">${station.sbi} è¼›</span> 
                            | å¯é‚„ï¼š<span style="color: var(--secondary);">${station.bemp} å€‹</span>
                        </p>
                    </div>
                    <span class="tag" style="background: var(--primary);">
                        ${station.distance.toFixed(2)} km
                    </span>
                `;
                
                // é»æ“Šåˆ—è¡¨é …ç›®æ™‚ï¼Œç§»å‹•åœ°åœ–ä¸¦æ‰“é–‹ InfoWindow
                listItem.addEventListener('click', () => {
                    if (map) {
                        const lat = parseFloat(station.lat);
                        const lng = parseFloat(station.lng);
                        map.setCenter({ lat: lat, lng: lng });
                        map.setZoom(16); 
                        
                        const targetMarker = window.youbikeMarkers.find(m => m.getTitle() === station.sna);
                        if (targetMarker) {
                            google.maps.event.trigger(targetMarker, 'click');
                        }
                    }
                });
                localList.appendChild(listItem);
            });
        }


        // =====================
        // ä»‹é¢èˆ‡äº‹ä»¶ç¶å®š (æ•´åˆåŠŸèƒ½)
        // =====================
        function bindEvents() {
            // --- 1. èªè¨€åˆ‡æ› ---
            btnZh.addEventListener('click', () => applyLang('zh-Hant'));
            btnEn.addEventListener('click', () => applyLang('en'));

            // --- 2. API è¨­å®š (æ›´æ–°ï¼šæ”¯æ´ Maps Key å„²å­˜) ---
            btnSaveAPI.addEventListener('click', () => {
                const geminiKey = inputGemini.value.trim();
                const mapsKey = inputMapsApi.value.trim();

                let geminiOk = false;
                if (geminiKey.length > 20 && geminiKey.startsWith('AIza')) { 
                    state.geminiKey = geminiKey;
                    localStorage.setItem('geminiKey', geminiKey);
                    setRagUI(true);
                    geminiOk = true;
                } else {
                    setRagUI(false);
                }
                
                let mapsOk = false;
                if (mapsKey.length > 20) {
                    state.mapsKey = mapsKey;
                    localStorage.setItem('mapsKey', mapsKey);
                    mapsOk = true;
                    // å¦‚æœ Maps Key æ”¹è®Šï¼Œé‡æ–°è¼‰å…¥åœ°åœ–
                    loadLocalInfoMap();
                }

                if (geminiOk && mapsOk) {
                    toast('API Keys å„²å­˜æˆåŠŸï¼æœå‹™æ ¸å¿ƒèˆ‡åœ°åœ–å•Ÿå‹•ã€‚', 'success');
                    chatBox.innerHTML = ''; 
                    addBubble('ai', t('chat_init').replace('å°šæœªé€£ç·š', 'å·²é€£ç·š'));
                } else if (geminiOk) {
                    toast(t('toast_key_ok'), 'success');
                } else {
                    toast('API Key è¨­å®šæœ‰èª¤ï¼Œè«‹æª¢æŸ¥ã€‚', 'error');
                }
            });

            // --- 3. çŸ¥è­˜åº«äº’å‹• ---
            // æœå°‹
            kbSearch.addEventListener('input', (e) => {
                state.search = e.target.value;
                renderKB();
            });

            // ç¯©é¸
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.filter = btn.getAttribute('data-filter');
                    renderKB();
                });
            });

            // --- 4. åŒ¯å…¥æ¨¡æ…‹è¦–çª—èˆ‡ CSV é‚è¼¯ ---
            btnImport.addEventListener('click', () => { modal.setAttribute('open', ''); });
            btnCloseModal.addEventListener('click', () => { modal.removeAttribute('open'); });
            btnCancel.addEventListener('click', () => { modal.removeAttribute('open'); });

            // å–®ç­†åŒ¯å…¥
            importForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = inputName.value.trim();
                const loc = inputLoc.value.trim();
                if (!name || !loc) {
                    toast(t('toast_import_error'), 'error');
                    return;
                }

                const newAsset = {
                    id: `custom-${Date.now()}`,
                    title_zh: name,
                    info_zh: loc + (inputType.value ? ` / ${inputType.value}` : ''),
                    title_en: name, 
                    info_en: loc,
                    type: (inputType.value || 'custom').toLowerCase(),
                    img_url: inputImgUrl.value || 'https://via.placeholder.com/640x360/443311/aaaaaa?text=Custom+Asset',
                    desc: inputDesc.value,
                };

                let stored = JSON.parse(localStorage.getItem('customKnowledge') || '[]');
                stored.push(newAsset);
                localStorage.setItem('customKnowledge', JSON.stringify(stored));
                loadKnowledge();
                renderKB();
                
                modal.removeAttribute('open');
                importForm.reset();
                toast(t('toast_import_ok', name), 'success');
            });

            // AI æ‘˜è¦ (æ¨¡æ“¬)
            btnAiSummarize.addEventListener('click', () => {
                toast(t('toast_ai_summarizing'), 'success');
                setTimeout(() => {
                    inputDesc.value = 'AI æ¨¡æ“¬æ‘˜è¦ï¼šé€™æ˜¯ä¸€å€‹ç”± AI è‡ªå‹•å¾å¤–éƒ¨è³‡æ–™ä¾†æºæ“·å–ä¸¦æ­¸ç´çš„ç°¡è¦æè¿°ã€‚é—œéµå­—åŒ…æ‹¬ï¼šæ–‡åŒ–ã€ç§‘æŠ€ã€åœ¨åœ°ç‰¹è‰²ã€‚';
                    toast(t('toast_ai_summarize_ok'), 'success');
                }, 1000);
            });
            
            // æ‰¹æ¬¡åŒ¯å…¥ CSV
            btnImportCsv.addEventListener('click', async () => {
                const file = inputFileCsv.files[0];
                if (!file) {
                    toast('è«‹å…ˆé¸æ“‡ä¸€å€‹ CSV æª”æ¡ˆã€‚', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvText = e.target.result;
                    const newAssets = parseCsv(csvText);

                    if (!newAssets || newAssets.length === 0) {
                        toast(t('toast_import_csv_error'), 'error');
                        return;
                    }

                    let stored = JSON.parse(localStorage.getItem('customKnowledge') || '[]');
                    stored = stored.concat(newAssets);
                    localStorage.setItem('customKnowledge', JSON.stringify(stored));
                    loadKnowledge();
                    renderKB();
                    
                    modal.removeAttribute('open');
                    importForm.reset(); 
                    toast(t('toast_import_csv_ok', newAssets.length), 'success');
                };

                reader.onerror = function() {
                    toast('æª”æ¡ˆè®€å–å¤±æ•—ã€‚', 'error');
                };

                reader.readAsText(file, 'UTF-8'); 
            });

            // --- 5. AI æ™ºèƒ½å°è¦½ ---
            btnSend.addEventListener('click', () => handleAIChat(chatInput.value));
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && chatInput.value.trim() !== '') {
                    handleAIChat(chatInput.value);
                }
            });
            
            // --- 6. åœ¨åœ°è³‡è¨Šåˆ—è¡¨ç¯©é¸ --- <--- NEW!
            filterButtonsLocal.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtonsLocal.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.localFilter = btn.getAttribute('data-filter');
                    
                    if (window.allYouBikeStations.length > 0) {
                        updateLocalList(window.allYouBikeStations); 
                    } else {
                        // å¦‚æœå°šæœªè¼‰å…¥ï¼Œå‰‡è§¸ç™¼ä¸€æ¬¡è¼‰å…¥
                        fetchYouBikeData(userLocation); 
                    }
                });
            });


            // --- 7. ä»‹é¢æŠ˜ç–Š ---
            // ... (èˆ‡ä¸Šå€‹ç‰ˆæœ¬ç›¸åŒ) ...
            [localToggle, meToggle].forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const body = toggle.nextElementSibling;
                    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                    toggle.setAttribute('aria-expanded', !isExpanded);
                    body.hidden = isExpanded;
                    const caret = $('.caret', toggle);
                    if (caret) caret.textContent = isExpanded ? 'â–¼' : 'â–²';
                });
            });

            // --- 8. å°èˆªåˆ‡æ› (æ¨¡æ“¬æ»¾å‹•) ---
            // ... (èˆ‡ä¸Šå€‹ç‰ˆæœ¬ç›¸åŒ) ...
            $$('.nav a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    $$('.nav a').forEach(a => a.classList.remove('active'));
                    this.classList.add('active');
                    const targetId = this.getAttribute('href');
                    const targetElement = $(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });
        }

        // =====================
        // Toast æ¶ˆæ¯
        // =====================
        function toast(message, type = '') {
            if (typeof message === 'function') return; 
            
            toaster.textContent = message;
            toaster.className = `toast show ${type}`;
            setTimeout(() => {
                toaster.classList.remove('show');
            }, 3000);
        }

        // å•Ÿå‹•å„€è¡¨æ¿
        init();
    })();
</script>

