<script>
    (function () {
        'use strict';
        // 工具：DOM 快捷
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        // =====================
        // i18n 字典 (已擴充)
        // =====================
        const i18n = {
            'zh-Hant': {
                ui_lang: '介面語言:',
                title: '文化智遊儀表板',
                nav_guide: '導覽', nav_knowledge: '知識庫', nav_experience: '體驗', nav_personal: '個人中心',
                h2_api: 'API 整合服務模組', p_api: '系統服務狀態與金鑰設定', status_rag: 'RAG 服務：尚未連線', status_data: '開放資料：同步中', btn_save: '儲存設定',
                h2_guide: 'AI 智能導覽', p_guide: '您的隨身文化嚮導', chat_init: '[系統初始化] 檢測到 RAG 核心未啟動。請在上方輸入您的 Gemini Key 以連線文化知識庫。', placeholder_chat: '輸入您的文化問題或導覽需求...', btn_send: '發送',
                h2_db: '文化知識庫', p_db: '探索全台文化資產 (RAG 資料源)', btn_import: '↓ 匯入新資料', placeholder_search: '搜尋古蹟、文物、歷史事件...',
                filter_all: '全部', filter_monument: '古蹟', filter_museum: '博物館', filter_intangible: '無形文化',
                h2_immersive: '沉浸式體驗', p_immersive: '啟動您的時光機', tag_ar: 'AR 實景還原', h4_anping: '安平古堡：熱蘭遮城 1632', tag_vr: 'VR 虛擬展館', h4_taipei: '已消失的台北城牆 (數位重建)',
                h2_local: '在地即時資訊', p_local: '整合開放資料', map_placeholder: '--- 互動地圖載入區域 ---', bus_route: '[市區公車] 77路', bus_status: '即將抵達：赤崁樓站 (3 分鐘)', event_name: '[節慶活動] 府城文化節', event_status: '進行中：孔廟園區 (距離 1.2km)',
                h2_personal: '個人化中心', p_personal: '您的文化足跡', card_fav: '我的收藏', card_fav_p: '您已收藏 12 個景點與 3 篇導覽', card_trip: '我的行程', card_trip_p: '您有 1 個即將到來的行程 (台南三日遊)', card_ach: '我的成就', card_ach_p: '已解鎖「府城探索者」徽章',
                
                // Modal & 匯入
                modal_title: '匯入自定義文化資產',
                modal_label_name: '資產名稱 (必填)',
                modal_label_location: '地點 / 縣市 (必填)',
                modal_label_type: '類型 (古蹟/博物館/無形文化...)',
                modal_label_img: '圖片 URL (選填)',
                modal_label_desc: '簡要描述 (用於 AI 導覽 RAG)',
                modal_h4_csv: '或：批次匯入 CSV 資料',
                btn_ai_summarize: '🤖 AI 自動摘要 (模擬)',
                btn_cancel: '取消',
                btn_submit: '單筆匯入並啟用',
                btn_import_csv: '批次匯入 CSV',
                
                // Toast
                toast_lang_switched: (isZh) => `介面已切換為 ${isZh ? '繁體中文' : 'English'}（已儲存）`,
                toast_key_ok: 'API Key 儲存並驗證成功！服務核心啟動。',
                toast_key_bad: 'Gemini API Key 格式錯誤或無效。',
                toast_need_key: '請先在 API 設定模組中輸入有效的 Gemini Key。',
                toast_import_error: '請填寫「資產名稱」與「地點」。',
                toast_import_ok: (name) => `成功匯入資產：「${name}」。已加入 RAG 資料源。`,
                toast_ai_summarizing: 'AI 摘要處理中...',
                toast_ai_summarize_ok: '摘要完成！已回填至描述欄位。',
                toast_import_csv_error: 'CSV 匯入失敗，請檢查檔案和格式 (需包含 title/location 欄位)。',
                toast_import_csv_ok: (count) => `成功匯入 ${count} 筆資產。已加入 RAG 資料源。`,
            },
            en: {
                ui_lang: 'Language:',
                title: 'Culture Guide Dashboard', nav_guide: 'Guide', nav_knowledge: 'Knowledge Base', nav_experience: 'Experience', nav_personal: 'Personal Center',
                h2_api: 'API Integration Module', p_api: 'System Status and Key Settings', status_rag: 'RAG Service: Disconnected', status_data: 'Open Data: Syncing', btn_save: 'Save Settings',
                h2_guide: 'AI Smart Guide', p_guide: 'Your Personal Culture Companion', chat_init: '[System Init] RAG Core Offline. Please enter your Gemini Key above to connect the Knowledge Base.', placeholder_chat: 'Enter your culture question or guidance request...', btn_send: 'Send',
                h2_db: "Cultural Knowledge Base", p_db: "Explore Taiwan's Cultural Assets (RAG Source)", btn_import: '↓ Import New Data', placeholder_search: 'Search: Monuments, artifacts, history...',
                filter_all: 'ALL', filter_monument: 'Monuments', filter_museum: 'Museums', filter_intangible: 'Intangible',
                h2_immersive: 'Immersive Experience', p_immersive: 'Launch Your Time Machine', tag_ar: 'AR Live Restoration', h4_anping: 'Anping Fort: Zeelandia 1632', tag_vr: 'VR Virtual Exhibition', h4_taipei: 'Lost Taipei City Walls (Digital)',
                h2_local: 'Local Real-Time Info', p_local: 'Open Data Integration', map_placeholder: '--- Interactive Map Loading Area ---', bus_route: '[TRANSIT] Route 77', bus_status: 'Arriving: Chikan Tower (3 min)', event_name: '[EVENT] Fucheng Culture Fest', event_status: 'Active: Confucius Temple (1.2km)',
                h2_personal: 'Personal Center', p_personal: 'Your Cultural Footprint', card_fav: 'My Favorites', card_fav_p: '12 assets and 3 tours saved.', card_trip: 'My Trips', card_trip_p: '1 upcoming itinerary (Tainan 3-Day)', card_ach: 'My Achievements', card_ach_p: "Achieved: 'Fucheng Explorer' Badge",
                
                // Modal & Import
                modal_title: 'Import Custom Cultural Asset',
                modal_label_name: 'Asset Name (Required)',
                modal_label_location: 'Location / City (Required)',
                modal_label_type: 'Type (Monument/Museum/Intangible...)',
                modal_label_img: 'Image URL (Optional)',
                modal_label_desc: 'Brief Description (for RAG)',
                modal_h4_csv: 'OR: Batch Import CSV Data',
                btn_ai_summarize: '🤖 AI Auto Summarize (Simulated)',
                btn_cancel: 'Cancel',
                btn_submit: 'Import Single Asset',
                btn_import_csv: 'Batch Import CSV',
                
                // Toast
                toast_lang_switched: (isZh) => `Language switched to ${isZh ? '繁體中文' : 'English'} (saved)`,
                toast_key_ok: 'API Key validated! Service core started.',
                toast_key_bad: 'Gemini API Key error or invalid.',
                toast_need_key: 'Please enter a valid Gemini Key in API settings first.',
                toast_import_error: 'Please fill Asset Name & Location.',
                toast_import_ok: (name) => `Imported: "${name}". Added to RAG source.`,
                toast_ai_summarizing: 'AI summarizing in progress...',
                toast_ai_summarize_ok: 'Summarization complete! Result filled into description.',
                toast_import_csv_error: 'CSV import failed. Check file and format (requires title/location columns).',
                toast_import_csv_ok: (count) => `Successfully imported ${count} assets. Added to RAG source.`,
            }
        };

        // =====================
        // App 狀態 & 全域變數
        // =====================
        const state = {
            lang: localStorage.getItem('lang') || 'zh-Hant',
            ragReady: localStorage.getItem('ragReady') === 'true',
            geminiKey: localStorage.getItem('geminiKey') || '',
            mapsKey: localStorage.getItem('mapsKey') || '', // 新增：Google Maps Key
            knowledge: [], 
            filter: 'all',
            search: '',
            localFilter: 'all', // 新增：YouBike 列表篩選狀態 ('all', 'bikes', 'docks')
        };

        const DEFAULT_KB = [
            { id: '1', type: 'monument', title_zh: '赤崁樓', info_zh: '台南市 / 一級古蹟', title_en: 'Chikan Tower', info_en: 'Tainan / Grade 1 Monument', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Chikan+Tower', desc: '赤崁樓始建於 1653 年，為荷蘭人所建，歷經清朝重建與日治時期修繕，是台南最具代表性的古蹟之一。'},
            { id: '2', type: 'museum', title_zh: '西門紅樓', info_zh: '台北市 / 歷史建築', title_en: 'Ximen Red House', info_en: 'Taipei / Historical Building', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Red+House', desc: '西門紅樓是一座兩層高的紅磚洋樓，見證了西門町的歷史發展。'},
            { id: '3', type: 'intangible', title_zh: '媽祖繞境', info_zh: '中台灣 / 無形文化', title_en: 'Mazu Pilgrimage', info_en: 'Central Taiwan / Intangible Heritage', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Mazu+Pilgrimage', desc: '中元普渡民俗與宗教文化的代表活動之一，強調對先人敬意與社群連結。'},
        ];
        
        // 地圖相關全域變數
        let map; // Google Map 實例
        let userLocation = { lat: 25.0478, lng: 121.5318 }; // 預設位置：台北車站
        window.youbikeMarkers = []; // 儲存所有 YouBike Marker 實例
        window.allYouBikeStations = []; // 儲存所有站點資料供列表篩選使用

        // =====================
        // DOM 參照
        // =====================
        const ragDot = $('#rag-dot');
        const ragText = $('#rag-text');
        const btnSaveAPI = $('#btn-save-api');
        const inputGemini = $('#gemini-api');
        const inputMapsApi = $('#maps-api'); // Maps API Input

        const btnZh = $('#btn-zh');
        const btnEn = $('#btn-en');

        const kbGrid = $('#kb-grid');
        const kbTpl = $('#kb-card-tpl');
        const kbSearch = $('#kb-search');
        const filterButtons = $$('.filter');

        const chatBox = $('#chat');
        const chatInput = $('#chat-input');
        const btnSend = $('#btn-send');

        const localToggle = $('#local-toggle');
        const meToggle = $('#me-toggle');
        
        const localList = $('#local-list'); // 即時資訊列表

        const modal = $('#import-modal');
        const btnImport = $('#btn-import');
        const btnCloseModal = $('#btn-close-modal');
        const btnCancel = $('#btn-cancel');
        const importForm = $('#import-form');
        
        // 匯入模組相關
        const inputName = $('#asset-name');
        const inputLoc = $('#asset-location');
        const inputType = $('#asset-type');
        const inputImgUrl = $('#asset-img-url');
        const inputDesc = $('#asset-desc');
        const btnAiSummarize = $('#btn-ai-summarize');
        const inputFileCsv = $('#asset-csv-file');
        const btnImportCsv = $('#btn-import-csv');
        
        // 列表篩選按鈕
        const filterButtonsLocal = $$('.filter-controls .filter-btn');

        const toaster = $('#toast');

        // =====================
        // 初始化
        // =====================
        function init() {
            // API 回填
            inputGemini.value = state.geminiKey;
            inputMapsApi.value = state.mapsKey;
            setRagUI(state.ragReady);

            // 語言 & 文案
            applyLang(state.lang, false); 

            // 知識庫載入
            loadKnowledge();
            renderKB();

            // 事件綁定
            bindEvents();

            // 啟動地圖模組 (在地即時資訊)
            loadLocalInfoMap();
            
            // 初始聊天
            if (state.ragReady) {
                chatBox.innerHTML = '';
                addBubble('ai', t('chat_init').replace('尚未連線', '已連線'));
            } else {
                addBubble('ai', t('chat_init'));
            }
        }

        // =====================
        // i18n
        // =====================
        function t(key, arg = null) {
            const lang = state.lang in i18n ? state.lang : 'zh-Hant';
            const val = i18n[lang][key];
            if (typeof val === 'function') {
                return val(arg);
            }
            return val ?? key;
        }

        function applyLang(lang, showToast = true) {
            state.lang = lang;
            const dict = i18n[lang] || i18n['zh-Hant'];
            // 更新 data-key 文案
            $$('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                let val = dict[key];

                if (typeof val === 'function') {
                    val = key; // 保持原樣
                }

                if (!val) return;
                if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                    el.placeholder = val;
                } else if (el.tagName !== 'INPUT' && el.tagName !== 'TEXTAREA') { // 避免覆蓋 input/textarea value
                    el.textContent = val;
                }
            });
            $('#app-title').textContent = t('title');
            localStorage.setItem('lang', lang);
            if (showToast) {
                toast(t('toast_lang_switched', lang === 'zh-Hant'), 'success');
            }
            renderKB(); // 切換卡片語言
            setRagUI(state.ragReady); // 更新 RAG 文案
        }

        // =====================
        // RAG / API 狀態
        // =====================
        function setRagUI(ready) {
            state.ragReady = ready;
            if (ready) {
                ragDot.classList.add('ok');
                ragText.textContent = (state.lang === 'zh-Hant') ? 'RAG 服務：已連線' : 'RAG Service: Connected';
            } else {
                ragDot.classList.remove('ok');
                ragText.textContent = t('status_rag');
            }
            localStorage.setItem('ragReady', ready);
        }
        
        // =====================
        // 知識庫：載入/儲存/渲染
        // (CSV 導入邏輯與上個版本相同)
        // =====================
        function loadKnowledge() {
            let custom = [];
            try { custom = JSON.parse(localStorage.getItem('customKnowledge') || '[]'); } catch {}
            custom = custom.map(a => ({ type: (a.type || 'custom').toLowerCase(), ...a }));
            state.knowledge = [...DEFAULT_KB, ...custom];
        }

        function renderKB() {
            // ... (與上個版本相同) ...
            kbGrid.innerHTML = '';
            const isZh = state.lang === 'zh-Hant';
            
            const filteredKB = state.knowledge.filter(asset => {
                const title = isZh ? asset.title_zh : asset.title_en;
                const matchesSearch = !state.search || title.toLowerCase().includes(state.search.toLowerCase());
                const matchesFilter = state.filter === 'all' || asset.type === state.filter;
                return matchesSearch && matchesFilter;
            });

            filteredKB.forEach(asset => {
                const clone = kbTpl.content.cloneNode(true);
                const card = $('.kb-card', clone);
                const img = $('img', clone);
                const titleEl = $('.title', clone);
                const metaEl = $('.meta', clone);

                card.setAttribute('data-id', asset.id);
                img.src = asset.img_url;
                img.alt = isZh ? asset.title_zh : asset.title_en;
                titleEl.textContent = isZh ? asset.title_zh : asset.title_en;
                metaEl.textContent = isZh ? asset.info_zh : asset.info_en;

                kbGrid.appendChild(clone);
            });
        }
        
        function parseCsv(csvText) {
             // ... (與上個版本相同) ...
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) return null; 
            const headers = lines[0].toLowerCase().split(',').map(h => h.trim()); 
            
            const requiredFields = ['title', 'location'];
            if (!requiredFields.every(field => headers.some(h => h.includes(field)))) {
                return null; 
            }

            const data = [];
            const now = Date.now();

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length !== headers.length) continue; 

                const asset = {
                    id: `custom-${now}-${i}`,
                    title_zh: values[headers.indexOf('title_zh')]?.trim() || values[headers.indexOf('title')]?.trim(),
                    info_zh: values[headers.indexOf('location_zh')]?.trim() || values[headers.indexOf('location')]?.trim() || '未知地點',
                    type: (values[headers.indexOf('type')]?.trim() || 'custom').toLowerCase(),
                    img_url: values[headers.indexOf('img_url')]?.trim() || 'https://via.placeholder.com/640x360/443311/aaaaaa?text=No+Image',
                    desc: values[headers.indexOf('desc')]?.trim() || '',
                    title_en: values[headers.indexOf('title_en')]?.trim() || values[headers.indexOf('title_zh')]?.trim(),
                    info_en: values[headers.indexOf('location_en')]?.trim() || values[headers.indexOf('location_zh')]?.trim() || 'Unknown Location',
                };

                if (asset.title_zh && asset.info_zh) {
                    data.push(asset);
                }
            }
            return data;
        }

        // =====================
        // 聊天 / RAG 模擬
        // (與上個版本相同)
        // =====================
        function addBubble(type, text) {
            const bubble = document.createElement('div');
            bubble.className = `bubble ${type}`;
            bubble.textContent = text;
            chatBox.appendChild(bubble);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function handleAIChat(question) {
            addBubble('user', question);
            chatInput.value = '';

            if (!state.ragReady) {
                setTimeout(() => {
                    addBubble('ai', t('toast_need_key'));
                }, 800);
                return;
            }

            setTimeout(() => {
                let response = `好的，關於「${question}」的資訊已從 RAG 知識庫中提取。`;
                
                const relevantAsset = state.knowledge.find(a => (a.title_zh + a.desc).includes(question.substring(0, 2)));

                if (relevantAsset) {
                    const title = (state.lang === 'zh-Hant') ? relevantAsset.title_zh : relevantAsset.title_en;
                    response += `\n\n[知識引用] 根據您提問的內容，知識庫中找到相關資產：${title} (${relevantAsset.info_zh})。\n描述：${relevantAsset.desc.substring(0, 50)}...`;
                } else {
                    response += `\n\n知識庫中未找到直接相關內容，AI 將以通用知識回答...`;
                }

                addBubble('ai', response);
            }, 1500);
        }
        
        // =====================
        // Google Maps & 即時資訊 (整合功能)
        // =====================
        
        /**
         * Helper function: 計算距離 (公里)
         */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球半徑 (公里)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // 距離 (公里)
        }

        /**
         * 啟動地圖和即時資料流程
         */
        async function loadLocalInfoMap() {
            const mapsApiKey = inputMapsApi.value;
            if (!mapsApiKey) {
                $('#map-container').innerHTML = `<p style="color:var(--bad); padding:1rem;">請在上方 API 模組輸入有效的 Maps API Key 以啟用互動地圖。</p>`;
                return;
            }

            // 1. 嘗試取得使用者位置
            getUserGeolocation().then(coords => {
                userLocation = { lat: coords.latitude, lng: coords.longitude };
            }).catch(() => {
                console.warn("無法取得使用者地理位置，使用預設座標 (台北)。");
            }).finally(() => {
                // 2. 初始化地圖
                initializeGoogleMap(mapsApiKey);

                // 3. 呼叫 YouBike 資料
                fetchYouBikeData(userLocation); 

                // 定時器：每 60 秒更新一次
                setInterval(() => fetchYouBikeData(userLocation), 60000); 
            });
        }

        function getUserGeolocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve(position.coords),
                        (error) => reject(error),
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                } else {
                    reject(new Error("瀏覽器不支援地理位置服務。"));
                }
            });
        }
        
        function initializeGoogleMap(apiKey) {
            if (window.google && window.google.maps) {
                window.renderMap(userLocation); 
                return;
            }
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=renderMap&libraries=places&v=weekly`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);

            window.renderMap = (center) => {
                if (!center) center = userLocation;

                const mapOptions = { center: center, zoom: 14, mapId: 'YOUR_MAP_ID', fullscreenControl: false, streetViewControl: false };

                map = new google.maps.Map(document.getElementById('map-container'), mapOptions);
                
                // 放置使用者位置標記
                new google.maps.Marker({ position: center, map: map, title: '您的位置', icon: { url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png', scaledSize: new google.maps.Size(40, 40) } });

                // 監聽地圖縮放和移動事件
                map.addListener('zoom_changed', filterMarkersByZoom);
                map.addListener('dragend', filterMarkersByZoom);
                
                if (window.allYouBikeStations.length > 0) {
                     renderYouBikeMarkers(window.allYouBikeStations);
                }
            };
        }

        async function fetchYouBikeData(center) {
            const youbikeApiUrl = 'https://data.ntpc.gov.tw/api/v1/rest/datastore/382000000A-000352-001'; 
            
            try {
                const response = await fetch(youbikeApiUrl, { method: 'GET', headers: { 'Accept': 'application/json' } });
                const data = await response.json();
                
                const stations = data.result.records; 
                
                // 篩選 5 公里範圍內的站點並計算距離
                const filteredStations = stations.filter(station => {
                    const stationLat = parseFloat(station.lat);
                    const stationLng = parseFloat(station.lng);
                    if (isNaN(stationLat) || isNaN(stationLng)) return false;

                    const distanceKm = getDistance(center.lat, center.lng, stationLat, stationLng);
                    station.distance = distanceKm; 
                    return distanceKm <= 5.0; 
                });

                renderYouBikeMarkers(filteredStations);
                updateLocalList(filteredStations);

            } catch (error) {
                console.error('YouBike API 串接失敗:', error);
                if (arguments.length > 0 && typeof arguments[0] === 'object') { 
                    toast('即時 YouBike 站點資料載入失敗。', 'error');
                }
            }
        }
        
        function filterMarkersByZoom() {
            if (!map || !window.youbikeMarkers) return;
            const currentZoom = map.getZoom();
            const threshold = 13; 
            
            if (currentZoom < threshold) {
                window.youbikeMarkers.forEach(marker => marker.setVisible(false));
                if (!map.isZoomedOut) {
                    toast('地圖縮放級別太低，已隱藏站點標記，請放大地圖。', 'info');
                    map.isZoomedOut = true;
                }
            } else {
                window.youbikeMarkers.forEach(marker => marker.setVisible(true));
                map.isZoomedOut = false;
            }
        }

        function renderYouBikeMarkers(stations) {
            if (!map) return;

            window.youbikeMarkers.forEach(marker => marker.setMap(null));
            window.youbikeMarkers = [];
            window.allYouBikeStations = stations; 

            stations.forEach(station => {
                const lat = parseFloat(station.lat);
                const lng = parseFloat(station.lng);
                const sbi = parseInt(station.sbi);
                
                const iconUrl = sbi > 0 ? 'http://maps.google.com/mapfiles/ms/icons/cycling.png' : 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'; 

                const marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    title: station.sna, 
                    icon: { url: iconUrl, scaledSize: new google.maps.Size(30, 30) }
                });

                const content = `<strong>${station.sna.replace('YouBike2.0_', '')}</strong><br>可借車輛：<span style="color: var(--ok);">${station.sbi} 輛</span><br>可還空位：<span style="color: var(--secondary);">${station.bemp} 個</span>`;
                const infoWindow = new google.maps.InfoWindow({ content: content });
                marker.addListener('click', () => { infoWindow.open(map, marker); });
                
                window.youbikeMarkers.push(marker); 
            });
            filterMarkersByZoom(); 
        }
        
        function updateLocalList(stations) {
            if (!stations) return;
            
            // 應用篩選邏輯
            const filteredAndSortedStations = stations
                .filter(station => {
                    const sbi = parseInt(station.sbi); 
                    const bemp = parseInt(station.bemp); 
                    
                    if (state.localFilter === 'bikes') {
                        return sbi >= 3;
                    } else if (state.localFilter === 'docks') {
                        return bemp >= 3;
                    }
                    return true;
                })
                .sort((a, b) => a.distance - b.distance); // 按距離排序

            localList.innerHTML = '';
            
            if (filteredAndSortedStations.length === 0) {
                let message = '附近沒有 YouBike 站點資料。';
                if (state.localFilter !== 'all') {
                     message = `目前條件下，附近沒有符合條件的站點。`;
                }
                localList.innerHTML = `<li class="kb-card" style="opacity:0.7;">${message}</li>`;
                return;
            }

            filteredAndSortedStations.forEach(station => {
                const listItem = document.createElement('li');
                listItem.className = 'kb-card real-time-card';
                listItem.innerHTML = `
                    <div style="flex-grow: 1;">
                        <p class="meta" style="color: var(--ok); font-weight: bold;">[YouBike 2.0 站點]</p>
                        <h4 class="title" style="margin-top: 0.2rem;">${station.sna.replace('YouBike2.0_', '')}</h4>
                        <p class="meta">
                            可借：<span style="color: ${station.sbi > 0 ? 'var(--ok)' : 'var(--bad)'};">${station.sbi} 輛</span> 
                            | 可還：<span style="color: var(--secondary);">${station.bemp} 個</span>
                        </p>
                    </div>
                    <span class="tag" style="background: var(--primary);">
                        ${station.distance.toFixed(2)} km
                    </span>
                `;
                
                // 點擊列表項目時，移動地圖並打開 InfoWindow
                listItem.addEventListener('click', () => {
                    if (map) {
                        const lat = parseFloat(station.lat);
                        const lng = parseFloat(station.lng);
                        map.setCenter({ lat: lat, lng: lng });
                        map.setZoom(16); 
                        
                        const targetMarker = window.youbikeMarkers.find(m => m.getTitle() === station.sna);
                        if (targetMarker) {
                            google.maps.event.trigger(targetMarker, 'click');
                        }
                    }
                });
                localList.appendChild(listItem);
            });
        }


        // =====================
        // 介面與事件綁定 (整合功能)
        // =====================
        function bindEvents() {
            // --- 1. 語言切換 ---
            btnZh.addEventListener('click', () => applyLang('zh-Hant'));
            btnEn.addEventListener('click', () => applyLang('en'));

            // --- 2. API 設定 (更新：支援 Maps Key 儲存) ---
            btnSaveAPI.addEventListener('click', () => {
                const geminiKey = inputGemini.value.trim();
                const mapsKey = inputMapsApi.value.trim();

                let geminiOk = false;
                if (geminiKey.length > 20 && geminiKey.startsWith('AIza')) { 
                    state.geminiKey = geminiKey;
                    localStorage.setItem('geminiKey', geminiKey);
                    setRagUI(true);
                    geminiOk = true;
                } else {
                    setRagUI(false);
                }
                
                let mapsOk = false;
                if (mapsKey.length > 20) {
                    state.mapsKey = mapsKey;
                    localStorage.setItem('mapsKey', mapsKey);
                    mapsOk = true;
                    // 如果 Maps Key 改變，重新載入地圖
                    loadLocalInfoMap();
                }

                if (geminiOk && mapsOk) {
                    toast('API Keys 儲存成功！服務核心與地圖啟動。', 'success');
                    chatBox.innerHTML = ''; 
                    addBubble('ai', t('chat_init').replace('尚未連線', '已連線'));
                } else if (geminiOk) {
                    toast(t('toast_key_ok'), 'success');
                } else {
                    toast('API Key 設定有誤，請檢查。', 'error');
                }
            });

            // --- 3. 知識庫互動 ---
            // 搜尋
            kbSearch.addEventListener('input', (e) => {
                state.search = e.target.value;
                renderKB();
            });

            // 篩選
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.filter = btn.getAttribute('data-filter');
                    renderKB();
                });
            });

            // --- 4. 匯入模態視窗與 CSV 邏輯 ---
            btnImport.addEventListener('click', () => { modal.setAttribute('open', ''); });
            btnCloseModal.addEventListener('click', () => { modal.removeAttribute('open'); });
            btnCancel.addEventListener('click', () => { modal.removeAttribute('open'); });

            // 單筆匯入
            importForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = inputName.value.trim();
                const loc = inputLoc.value.trim();
                if (!name || !loc) {
                    toast(t('toast_import_error'), 'error');
                    return;
                }

                const newAsset = {
                    id: `custom-${Date.now()}`,
                    title_zh: name,
                    info_zh: loc + (inputType.value ? ` / ${inputType.value}` : ''),
                    title_en: name, 
                    info_en: loc,
                    type: (inputType.value || 'custom').toLowerCase(),
                    img_url: inputImgUrl.value || 'https://via.placeholder.com/640x360/443311/aaaaaa?text=Custom+Asset',
                    desc: inputDesc.value,
                };

                let stored = JSON.parse(localStorage.getItem('customKnowledge') || '[]');
                stored.push(newAsset);
                localStorage.setItem('customKnowledge', JSON.stringify(stored));
                loadKnowledge();
                renderKB();
                
                modal.removeAttribute('open');
                importForm.reset();
                toast(t('toast_import_ok', name), 'success');
            });

            // AI 摘要 (模擬)
            btnAiSummarize.addEventListener('click', () => {
                toast(t('toast_ai_summarizing'), 'success');
                setTimeout(() => {
                    inputDesc.value = 'AI 模擬摘要：這是一個由 AI 自動從外部資料來源擷取並歸納的簡要描述。關鍵字包括：文化、科技、在地特色。';
                    toast(t('toast_ai_summarize_ok'), 'success');
                }, 1000);
            });
            
            // 批次匯入 CSV
            btnImportCsv.addEventListener('click', async () => {
                const file = inputFileCsv.files[0];
                if (!file) {
                    toast('請先選擇一個 CSV 檔案。', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvText = e.target.result;
                    const newAssets = parseCsv(csvText);

                    if (!newAssets || newAssets.length === 0) {
                        toast(t('toast_import_csv_error'), 'error');
                        return;
                    }

                    let stored = JSON.parse(localStorage.getItem('customKnowledge') || '[]');
                    stored = stored.concat(newAssets);
                    localStorage.setItem('customKnowledge', JSON.stringify(stored));
                    loadKnowledge();
                    renderKB();
                    
                    modal.removeAttribute('open');
                    importForm.reset(); 
                    toast(t('toast_import_csv_ok', newAssets.length), 'success');
                };

                reader.onerror = function() {
                    toast('檔案讀取失敗。', 'error');
                };

                reader.readAsText(file, 'UTF-8'); 
            });

            // --- 5. AI 智能導覽 ---
            btnSend.addEventListener('click', () => handleAIChat(chatInput.value));
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && chatInput.value.trim() !== '') {
                    handleAIChat(chatInput.value);
                }
            });
            
            // --- 6. 在地資訊列表篩選 --- <--- NEW!
            filterButtonsLocal.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtonsLocal.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.localFilter = btn.getAttribute('data-filter');
                    
                    if (window.allYouBikeStations.length > 0) {
                        updateLocalList(window.allYouBikeStations); 
                    } else {
                        // 如果尚未載入，則觸發一次載入
                        fetchYouBikeData(userLocation); 
                    }
                });
            });


            // --- 7. 介面折疊 ---
            // ... (與上個版本相同) ...
            [localToggle, meToggle].forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const body = toggle.nextElementSibling;
                    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                    toggle.setAttribute('aria-expanded', !isExpanded);
                    body.hidden = isExpanded;
                    const caret = $('.caret', toggle);
                    if (caret) caret.textContent = isExpanded ? '▼' : '▲';
                });
            });

            // --- 8. 導航切換 (模擬滾動) ---
            // ... (與上個版本相同) ...
            $$('.nav a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    $$('.nav a').forEach(a => a.classList.remove('active'));
                    this.classList.add('active');
                    const targetId = this.getAttribute('href');
                    const targetElement = $(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });
        }

        // =====================
        // Toast 消息
        // =====================
        function toast(message, type = '') {
            if (typeof message === 'function') return; 
            
            toaster.textContent = message;
            toaster.className = `toast show ${type}`;
            setTimeout(() => {
                toaster.classList.remove('show');
            }, 3000);
        }

        // 啟動儀表板
        init();
    })();
</script>

